name: Deploy to Snowflake

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Export Credentials and Run schemachange
        run: |
          export SF_ACCOUNT="fy50488.central-us.azure"
          export SF_USERNAME="github_actions_user"
          export SF_PASSWORD=":3&a493vOqvtxQE8"
          export SF_ROLE="DATA_TEAM"
          export SF_WAREHOUSE="PUBLIC_WH"
          export SF_DATABASE="BIGIRON_WAREHOUSE"
          export SF_SCHEMA="PUBLIC_DEV"

          echo "Verifying exported variables..."
          env | grep SF_

          schemachange -f $GITHUB_WORKSPACE/migrations --create-change-history-table \
            --account "$SF_ACCOUNT" \
            --user "$SF_USERNAME" \
            --password "$SF_PASSWORD" \
            --role "$SF_ROLE" \
            --warehouse "$SF_WAREHOUSE" \
            --database "$SF_DATABASE" \
            --schema "$SF_SCHEMA"
